---
phase: 04-forms-database
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - apps/spechack/src/lib/card-utils.ts
  - apps/spechack/src/app/[locale]/_actions/register.actions.ts
  - apps/spechack/src/app/[locale]/_actions/ambassador.actions.ts
autonomous: true
must_haves:
  truths:
    - "Registration Server Action validates input and inserts into spechack_participants with sequential agent_number"
    - "Duplicate email returns existing card data without creating new record"
    - "Ambassador Server Action validates input and inserts into spechack_ambassadors"
    - "Card gradient and builder class are generated deterministically from name"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "Fixed spechack_track enum (virtual/hub), gradientData column, community field replacing university/motivation"
      contains: "virtual.*hub"
    - path: "apps/spechack/src/lib/card-utils.ts"
      provides: "hashStr, generateCardGradient, getRandomBuilderClass, BUILDER_CLASSES"
      exports: ["generateCardGradient", "getRandomBuilderClass", "BUILDER_CLASSES"]
    - path: "apps/spechack/src/app/[locale]/_actions/register.actions.ts"
      provides: "submitRegistration Server Action with Zod validation"
      exports: ["submitRegistration", "RegisterFormState"]
    - path: "apps/spechack/src/app/[locale]/_actions/ambassador.actions.ts"
      provides: "submitAmbassador Server Action with Zod validation"
      exports: ["submitAmbassador", "AmbassadorFormState"]
  key_links:
    - from: "apps/spechack/src/app/[locale]/_actions/register.actions.ts"
      to: "packages/database/src/schema.ts"
      via: "import spechackParticipants from @404tf/database/schema"
      pattern: "spechackParticipants"
    - from: "apps/spechack/src/app/[locale]/_actions/register.actions.ts"
      to: "apps/spechack/src/lib/card-utils.ts"
      via: "import generateCardGradient, getRandomBuilderClass"
      pattern: "generateCardGradient|getRandomBuilderClass"
    - from: "apps/spechack/src/app/[locale]/_actions/ambassador.actions.ts"
      to: "packages/database/src/schema.ts"
      via: "import spechackAmbassadors from @404tf/database/schema"
      pattern: "spechackAmbassadors"
---

<objective>
Fix database schema mismatches and create Server Actions for registration and ambassador forms.

Purpose: Establish the complete backend foundation (schema + card utils + Server Actions) so that Plan 02 can wire up client form components with zero backend work remaining.
Output: Updated schema pushed to Neon, card-utils module, two Server Actions ready for useActionState binding.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-forms-database/04-RESEARCH.md

@packages/database/src/schema.ts
@packages/database/src/index.ts
@apps/landing/src/app/[locale]/_actions/intent.actions.ts
@apps/spechack/src/app/[locale]/_components/Hero.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix database schema and push to Neon</name>
  <files>packages/database/src/schema.ts</files>
  <action>
  Modify `packages/database/src/schema.ts` with these changes:

  1. **Replace spechack_track enum values:**
     Change `["web", "mobile", "ai", "iot", "open"]` to `["virtual", "hub"]`.
     This fixes the mismatch between the enum and the Hero form toggle (REG-04).

  2. **Change agent_number to serial:**
     Replace `agentNumber: integer("agent_number")` with `agentNumber: serial("agent_number").notNull()`.
     Import `serial` from `drizzle-orm/pg-core`. This auto-creates a PostgreSQL sequence for collision-free sequential assignment (REG-02).
     Note: `serial` auto-generates; do NOT also add `.default()`. The `serial` type handles it.

  3. **Add gradientData column to spechack_participants:**
     Add `gradientData: text("gradient_data")` after `builderClass`. Stores JSON string `{"from":"hsl(...)","to":"hsl(...)","angle":180}` (REG-04).

  4. **Fix spechack_ambassadors fields:**
     - Remove `university: text("university").notNull()`
     - Rename `motivation` to `community`: change `motivation: text("motivation").notNull()` to `community: text("community").notNull()`
     This aligns with AMB-02 which stores "community description" (not university/motivation).

  5. **Update type exports** -- the inferred types will auto-update from the table changes, no manual changes needed.

  After editing schema.ts, run `bun run db:push` from the monorepo root to apply changes to Neon. Since this is pre-launch with no production data, destructive push is fine.

  IMPORTANT: The `serial` column type in Drizzle creates a PostgreSQL `SERIAL` which auto-increments. When inserting, do NOT pass `agentNumber` -- let the DB assign it. The `.returning()` call will give back the assigned value.
  </action>
  <verify>
  Run `bun run db:push` from monorepo root -- should succeed without errors.
  Verify schema changes by reading the updated file and confirming:
  - spechackTrackEnum has `["virtual", "hub"]`
  - agentNumber uses `serial("agent_number")`
  - gradientData column exists
  - spechackAmbassadors has `community` field, no `university` or `motivation`
  </verify>
  <done>Schema pushed to Neon with corrected track enum, serial agent_number, gradientData column, and fixed ambassador fields.</done>
</task>

<task type="auto">
  <name>Task 2: Port card-utils and create Server Actions</name>
  <files>
    apps/spechack/src/lib/card-utils.ts
    apps/spechack/src/app/[locale]/_actions/register.actions.ts
    apps/spechack/src/app/[locale]/_actions/ambassador.actions.ts
  </files>
  <action>
  **A) Create `apps/spechack/src/lib/card-utils.ts`** -- server-safe card generation utilities ported from `~/Projects/spechack-blueprint/src/lib/cardUtils.ts`.

  Include ONLY the server-safe functions (no DOM/Canvas/localStorage):
  - `BUILDER_CLASSES` array (6 builder classes with bilingual `desc: { es, en }`)
  - `hashStr(s: string): number` -- deterministic hash
  - `GRADIENT_COMBOS` array (8 HSL color pairs)
  - `generateCardGradient(name: string): { from: string; to: string; angle: number }` -- deterministic from name
  - `getRandomBuilderClass(): BuilderClass` -- random assignment at registration time
  - `getDeterministicBuilderClass(name: string): BuilderClass` -- for Phase 6 challenge pages
  - `BuilderClass` type export

  Export the `BuilderClass` type and all functions as named exports. Do NOT include `generateAgentNumber`, `drawCardToCanvas`, `downloadCard`, `saveCardToStorage`, `loadCardFromStorage`, `getCountryFlag`, `generateDeterministicCard`, or `CardData` -- those are for Phase 5 (Canvas) or are replaced by DB logic.

  **B) Create `apps/spechack/src/app/[locale]/_actions/register.actions.ts`**

  Follow the landing app's `intent.actions.ts` pattern exactly:

  ```
  "use server";
  ```

  - Import `z` from `"zod"`, `db` from `"@404tf/database"`, `spechackParticipants` from `"@404tf/database/schema"`, `eq` from `"drizzle-orm"`.
  - Import `generateCardGradient`, `getRandomBuilderClass` from `"@/lib/card-utils"`.

  **Zod schema (registerSchema):**
  - `name`: `z.string().min(2, "Name must be at least 2 characters")`
  - `email`: `z.string().email("Invalid email")`
  - `city`: `z.string().min(1, "City is required")`
  - `track`: `z.enum(["virtual", "hub"])`
  - `locale`: `z.enum(["es", "en"])`

  NOTE: The spechack app has Zod v4 (`^4.3.6`). In Zod v4, `safeParse` and `error.flatten().fieldErrors` work the same as v3. If type issues arise with `flatten()`, use `validation.error.issues` to manually extract field errors.

  **RegisterFormState type:**
  ```typescript
  export type RegisterFormState = {
    success: boolean;
    message: string;
    errors?: Record<string, string[]>;
    data?: {
      agentNumber: string;
      name: string;
      builderClass: string;
      builderClassDesc: { es: string; en: string };
      gradientData: string;
    };
  } | null;
  ```

  **submitRegistration function:**
  1. Parse `formData` with `Object.fromEntries(formData)` then `registerSchema.safeParse(raw)`
  2. If validation fails, return `{ success: false, message: "validation", errors: validation.error.flatten().fieldErrors }`
  3. Check duplicate: `db.query.spechackParticipants.findFirst({ where: eq(spechackParticipants.email, email) })`
  4. If existing, return `{ success: true, message: "existing", data: { agentNumber: SPEC-XXXX formatted, name, builderClass, builderClassDesc from BUILDER_CLASSES lookup, gradientData } }`
     - For builderClassDesc lookup on existing records: find matching class in BUILDER_CLASSES by name, or return a fallback `{ es: "", en: "" }` if not found
  5. If new: generate `builderClass` via `getRandomBuilderClass()`, generate `gradient` via `generateCardGradient(name)`, insert with `.values({ name, email, city, track, builderClass: builderClass.name, gradientData: JSON.stringify(gradient), locale }).returning()`
  6. Return success with card data from the inserted row. Format agentNumber as `SPEC-${participant.agentNumber.toString().padStart(4, "0")}`.
  7. Wrap everything in try/catch, return `{ success: false, message: "error" }` on catch.

  **C) Create `apps/spechack/src/app/[locale]/_actions/ambassador.actions.ts`**

  Same pattern as register.actions.ts but simpler:

  **Zod schema (ambassadorSchema):**
  - `name`: `z.string().min(2, "Name must be at least 2 characters")`
  - `email`: `z.string().email("Invalid email")`
  - `city`: `z.string().min(1, "City is required")`
  - `community`: `z.string().min(10, "Please describe your community")`
  - `locale`: `z.enum(["es", "en"])`

  **AmbassadorFormState type:**
  ```typescript
  export type AmbassadorFormState = {
    success: boolean;
    message: string;
    errors?: Record<string, string[]>;
  } | null;
  ```

  **submitAmbassador function:**
  1. Parse + validate with Zod
  2. Insert into `spechackAmbassadors` with `.values({ name, email, city, community, locale })`
  3. Return `{ success: true, message: "success" }`
  4. Catch errors, return `{ success: false, message: "error" }`

  No duplicate detection for ambassadors -- multiple applications from same email are acceptable.
  </action>
  <verify>
  1. Run `bun run check` from `apps/spechack/` to verify Biome passes (no lint errors).
  2. Run `bun run build` from `apps/spechack/` -- should compile without TypeScript errors.
  3. Verify card-utils.ts exports: `generateCardGradient`, `getRandomBuilderClass`, `getDeterministicBuilderClass`, `BUILDER_CLASSES`, `BuilderClass`.
  4. Verify register.actions.ts exports: `submitRegistration`, `RegisterFormState`.
  5. Verify ambassador.actions.ts exports: `submitAmbassador`, `AmbassadorFormState`.
  </verify>
  <done>
  - card-utils.ts has server-safe card generation (6 builder classes, 8 gradient combos, deterministic hash)
  - register.actions.ts handles validation, duplicate detection, sequential agent number, card data generation
  - ambassador.actions.ts handles validation and database insertion
  - All files pass Biome lint and TypeScript compilation
  </done>
</task>

</tasks>

<verification>
1. `bun run db:push` succeeds with updated schema
2. `bun run build` in apps/spechack compiles without errors
3. `bun run check` passes Biome lint
4. Schema has correct track enum, serial agent_number, gradientData column, community field
5. Server Actions follow the landing app's FormState pattern exactly
</verification>

<success_criteria>
- Database schema matches all REG-04 and AMB-02 field requirements
- agent_number uses PostgreSQL SERIAL for collision-free sequential assignment (REG-02)
- Registration Server Action handles duplicate emails gracefully (REG-03)
- Card gradient is deterministic from name, builder class is random at registration time
- Ambassador Server Action validates and inserts with correct fields
- All code compiles and lints cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-forms-database/04-01-SUMMARY.md`
</output>
