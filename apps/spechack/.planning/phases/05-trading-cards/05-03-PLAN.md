---
phase: 05-trading-cards
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/app/[locale]/_components/CardReveal.tsx
  - src/app/[locale]/_components/RegistrationForm.tsx
  - src/app/[locale]/_components/Hero.tsx
autonomous: true

must_haves:
  truths:
    - "User completing registration sees animated card reveal with scale+rotateY+fade animation"
    - "User sees download, share on X, and challenge buttons after card reveal"
    - "User clicking Download Card receives a PNG file via Canvas API"
    - "User clicking Share on X opens pre-filled tweet in new tab"
    - "User clicking Challenge a Friend sees expandable share panel with copy, WhatsApp, LinkedIn"
    - "User clicking Copy link gets challenge URL copied to clipboard with visual confirmation"
    - "User's card data is saved to localStorage after successful registration"
    - "Returning user with localStorage data sees their card immediately without re-registering"
    - "City value is preserved after form submission for CardData construction"
  artifacts:
    - path: "src/app/[locale]/_components/CardReveal.tsx"
      provides: "Post-registration card reveal with action buttons"
      exports: ["CardReveal"]
      min_lines: 80
    - path: "src/app/[locale]/_components/RegistrationForm.tsx"
      provides: "Updated form with CardReveal integration and localStorage check"
      exports: ["RegistrationForm"]
    - path: "src/app/[locale]/_components/Hero.tsx"
      provides: "Updated Hero passing card translations to RegistrationForm"
      exports: ["Hero"]
  key_links:
    - from: "src/app/[locale]/_components/CardReveal.tsx"
      to: "src/app/[locale]/_components/TradingCard.tsx"
      via: "renders TradingCard inside motion.div"
      pattern: "<TradingCard"
    - from: "src/app/[locale]/_components/CardReveal.tsx"
      to: "src/lib/card-utils.client.ts"
      via: "calls downloadCard on button click"
      pattern: "downloadCard"
    - from: "src/app/[locale]/_components/CardReveal.tsx"
      to: "src/lib/share-utils.ts"
      via: "builds share URLs for X, WhatsApp, LinkedIn"
      pattern: "buildTweetUrl|buildWhatsAppUrl|buildLinkedInUrl"
    - from: "src/app/[locale]/_components/RegistrationForm.tsx"
      to: "src/app/[locale]/_components/CardReveal.tsx"
      via: "renders CardReveal on success state"
      pattern: "<CardReveal"
    - from: "src/app/[locale]/_components/RegistrationForm.tsx"
      to: "src/lib/card-utils.client.ts"
      via: "saves/loads card from localStorage"
      pattern: "saveCardToStorage|loadCardFromStorage"
    - from: "src/app/[locale]/_components/Hero.tsx"
      to: "src/app/[locale]/_components/RegistrationForm.tsx"
      via: "passes cardTranslations prop"
      pattern: "cardTranslations"
---

<objective>
Create CardReveal component with animated card display and action buttons, integrate it into RegistrationForm's success state, and wire up card translations from Hero server component.

Purpose: This is the core user-facing feature -- after registration, users see their animated trading card with download, share, and challenge capabilities. localStorage persistence ensures returning users see their card without re-registering.

Output: CardReveal.tsx client component, updated RegistrationForm.tsx, updated Hero.tsx with card translation pass-through.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-trading-cards/05-RESEARCH.md
@.planning/phases/05-trading-cards/05-01-SUMMARY.md
@.planning/phases/05-trading-cards/05-02-SUMMARY.md
@src/app/[locale]/_components/RegistrationForm.tsx
@src/app/[locale]/_components/Hero.tsx
@src/app/[locale]/_actions/register.actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardReveal component</name>
  <files>src/app/[locale]/_components/CardReveal.tsx</files>
  <action>
Create `CardReveal.tsx` as a `"use client"` component. Port from blueprint `CardReveal.tsx` with Next.js adaptations.

Props type:
```typescript
type CardRevealProps = {
  card: CardData;
  locale: "es" | "en";
  translations: {
    download: string;
    shareX: string;
    challenge: string;
    challengeCopy: string;
    challengeWhatsApp: string;
    challengeLinkedIn: string;
    recruitMore: string;
    tweetTemplate: string;
  };
};
```

**Key adaptations from blueprint:**
1. **No `useLang()`** — use `locale` prop
2. **No `t.*` imports** — use `translations` prop for all display strings
3. **Named export** — `export function CardReveal(...)`
4. **Use share-utils.ts** — import `buildTweetUrl`, `buildWhatsAppUrl`, `buildLinkedInUrl`, `buildChallengeLink` from `@/lib/share-utils`
5. **Use card-utils.client.ts** — import `downloadCard` from `@/lib/card-utils.client`
6. **Challenge link construction** — use `buildChallengeLink(card.name, window.location.origin)` inside event handler (NOT at render time — avoids SSR/hydration issues per research pitfall #5)
7. **Tweet text construction** — build from `translations.tweetTemplate` by replacing `{agent}`, `{cls}`, `{link}` placeholders

State: `copied` (boolean), `showShare` (boolean) — same as blueprint.

Component structure (matching blueprint exactly):
- Outer `motion.div` with `initial={{ opacity: 0 }} animate={{ opacity: 1 }}`
- Card reveal: `motion.div` with `initial={{ opacity: 0, scale: 0.8, rotateY: -15 }} animate={{ opacity: 1, scale: 1, rotateY: 0 }} transition={{ duration: 0.8, ease: "easeOut" }}` wrapping `<TradingCard card={card} locale={locale} />` at `w-[200px] sm:w-[240px] mx-auto`
- Action buttons: `motion.div` with `delay: 0.6` containing:
  - Download button (calls `downloadCard(card, locale)`) with `Download` icon from lucide-react
  - Share on X button (calls `handleShareX`) with `Share2` icon
  - Challenge button (toggles `showShare`) with `Swords` icon, primary styled
- Share panel: `AnimatePresence` wrapping conditional `motion.div` with height animation showing:
  - Challenge link text
  - Copy button (calls `navigator.clipboard.writeText`, shows `Check` icon for 2s then back to `Copy`)
  - WhatsApp button
  - LinkedIn button
- Recruit more text at bottom

Use exact Tailwind classes from blueprint for all buttons and layout.
  </action>
  <verify>Run `bun run build` — no errors. Verify CardReveal imports TradingCard, downloadCard, share utils. Verify no direct window access at render time.</verify>
  <done>CardReveal.tsx renders animated card with staggered reveal animation, download/share/challenge action buttons, expandable share panel with copy/WhatsApp/LinkedIn, and recruit-more footer text.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CardReveal into RegistrationForm and update Hero</name>
  <files>src/app/[locale]/_components/RegistrationForm.tsx, src/app/[locale]/_components/Hero.tsx</files>
  <action>
**RegistrationForm.tsx** — Three changes:

1. **Add controlled city state** — Add `const [city, setCity] = useState("")` alongside existing `track` state. Make the city input controlled (`value={city} onChange={(e) => setCity(e.target.value)}`). This preserves the city value after form submission (research pitfall #2).

2. **Add `cardTranslations` prop** — Extend `RegistrationFormProps` with:
```typescript
cardTranslations: {
  download: string;
  shareX: string;
  challenge: string;
  challengeCopy: string;
  challengeWhatsApp: string;
  challengeLinkedIn: string;
  recruitMore: string;
  tweetTemplate: string;
};
```

3. **Replace success state with CardReveal** — When `state?.success`, construct `CardData` from `state.data` + local form values, save to localStorage, and render CardReveal:
```typescript
if (state?.success) {
  const cardData: CardData = {
    agentNumber: state.data.agentNumber,
    name: state.data.name,
    city: city, // from controlled useState
    track: track, // from existing useState
    builderClass: {
      name: state.data.builderClass,
      desc: state.data.builderClassDesc,
    },
    gradient: JSON.parse(state.data.gradientData),
  };
  // Save to localStorage for returning users
  saveCardToStorage(cardData);
  return <CardReveal card={cardData} locale={locale} translations={cardTranslations} />;
}
```

4. **Add localStorage check on mount** — Add `useEffect` + `savedCard` state:
```typescript
const [savedCard, setSavedCard] = useState<CardData | null>(null);

useEffect(() => {
  const loaded = loadCardFromStorage();
  if (loaded) setSavedCard(loaded);
}, []);

// Before the form return, after the state?.success check:
if (savedCard) {
  return <CardReveal card={savedCard} locale={locale} translations={cardTranslations} />;
}
```

Import `CardData` from `@/lib/card-utils`, `saveCardToStorage`, `loadCardFromStorage` from `@/lib/card-utils.client`, `CardReveal` from `./CardReveal`, and `useEffect` from React.

**Hero.tsx** — Pass card translations to RegistrationForm:

1. Add `const cardT = await getTranslations("cards");` alongside existing `t` call
2. Add `cardTranslations` prop to `<RegistrationForm>`:
```typescript
cardTranslations={{
  download: cardT("download"),
  shareX: cardT("shareX"),
  challenge: cardT("challenge"),
  challengeCopy: cardT("challengeCopy"),
  challengeWhatsApp: cardT("challengeWhatsApp"),
  challengeLinkedIn: cardT("challengeLinkedIn"),
  recruitMore: cardT("recruitMore"),
  tweetTemplate: cardT("tweetTemplate"),
}}
```
  </action>
  <verify>Run `bun run build` — no errors. Run `bun run lint` — passes. Verify RegistrationForm has controlled city input, localStorage check useEffect, CardReveal rendering on success. Verify Hero passes cardTranslations.</verify>
  <done>RegistrationForm shows CardReveal on success (both new registration and returning user via localStorage). Hero passes card translations through to RegistrationForm. City value preserved via controlled state. Card data saved to localStorage on reveal.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes
2. `bun run lint` passes
3. CardReveal.tsx has "use client", named export, uses translation props (not context)
4. RegistrationForm.tsx has controlled city input, localStorage check, CardReveal integration
5. Hero.tsx fetches "cards" translations and passes as cardTranslations prop
6. No `window` access at render time (only in event handlers and useEffect)
7. Full flow: register -> success -> CardReveal with animated card + action buttons
</verification>

<success_criteria>
- CARD-01: After registration, user sees animated card reveal (scale, rotateY, fade stagger)
- CARD-02: Trading card displays all identity elements via TradingCard component
- CARD-03: Deterministic gradient visible on card
- CARD-04: Builder class displayed (randomly assigned at registration time by server action)
- CARD-05: Download Card button triggers Canvas PNG export
- CARD-06: Share on X opens pre-filled tweet
- CARD-07: WhatsApp, LinkedIn, copy-to-clipboard all functional
- CARD-09: Card data persisted via localStorage, returning users see card without re-registering
</success_criteria>

<output>
After completion, create `.planning/phases/05-trading-cards/05-03-SUMMARY.md`
</output>
