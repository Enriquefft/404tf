---
phase: 05-trading-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/card-utils.ts
  - src/lib/card-utils.client.ts
  - src/lib/share-utils.ts
  - messages/en.json
  - messages/es.json
autonomous: true

must_haves:
  truths:
    - "CardData type is importable from card-utils.ts in both server and client code"
    - "CITY_FLAGS map resolves known cities to flag emoji and unknown cities to globe fallback"
    - "Canvas drawing function produces 600x800 HTMLCanvasElement with card visual elements"
    - "Download function triggers PNG file download in browser"
    - "localStorage save/load round-trips CardData correctly"
    - "Share URL builders produce valid encoded URLs for X, WhatsApp, LinkedIn"
    - "Both en.json and es.json have complete cards namespace with all translation keys"
  artifacts:
    - path: "src/lib/card-utils.ts"
      provides: "CardData type, CITY_FLAGS, getCountryFlag"
      contains: "CardData"
    - path: "src/lib/card-utils.client.ts"
      provides: "drawCardToCanvas, downloadCard, saveCardToStorage, loadCardFromStorage"
      contains: "use client"
    - path: "src/lib/share-utils.ts"
      provides: "buildTweetUrl, buildWhatsAppUrl, buildLinkedInUrl, buildChallengeLink"
      exports: ["buildTweetUrl", "buildWhatsAppUrl", "buildLinkedInUrl", "buildChallengeLink"]
    - path: "messages/en.json"
      provides: "cards namespace translations (EN)"
      contains: "cards"
    - path: "messages/es.json"
      provides: "cards namespace translations (ES)"
      contains: "cards"
  key_links:
    - from: "src/lib/card-utils.client.ts"
      to: "src/lib/card-utils.ts"
      via: "import CardData type and getCountryFlag"
      pattern: "import.*card-utils"
    - from: "src/lib/share-utils.ts"
      to: "window.location.origin"
      via: "buildChallengeLink uses origin parameter"
      pattern: "origin"
---

<objective>
Add CardData type, city flags, client-side Canvas/download/localStorage utilities, share URL builders, and card translation namespace to both locale files.

Purpose: Establish all data types, utility functions, and translations needed by the trading card visual components (Plans 05-02 through 05-04). Splitting server-safe utils from browser-only utils prevents SSR errors.

Output: Extended card-utils.ts, new card-utils.client.ts, new share-utils.ts, updated en.json and es.json with "cards" namespace.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-trading-cards/05-RESEARCH.md
@src/lib/card-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend card-utils.ts and create card-utils.client.ts</name>
  <files>src/lib/card-utils.ts, src/lib/card-utils.client.ts</files>
  <action>
**card-utils.ts** — Add these to the existing file (keep all existing exports):

1. Add `CardData` type (NO email field — differs from blueprint which has email):
```typescript
export type CardData = {
  agentNumber: string;
  name: string;
  city: string;
  track: "virtual" | "hub";
  builderClass: BuilderClass;
  gradient: { from: string; to: string; angle: number };
};
```

2. Add `CITY_FLAGS` map (copy from blueprint `cardUtils.ts` lines 57-66):
```typescript
const CITY_FLAGS: Record<string, string> = {
  lima: "\u{1F1F5}\u{1F1EA}", "sao paulo": "\u{1F1E7}\u{1F1F7}", ... (all 25 entries from blueprint)
  virtual: "\u{1F310}",
};
```

3. Add `getCountryFlag()`:
```typescript
export function getCountryFlag(city: string): string {
  return CITY_FLAGS[city.toLowerCase().trim()] ?? "\u{1F30D}";
}
```

**card-utils.client.ts** — Create new file with `"use client"` directive:

1. Import `CardData`, `getCountryFlag` from `@/lib/card-utils`
2. Port `drawCardToCanvas(card: CardData, locale: "es" | "en"): HTMLCanvasElement` from blueprint (lines 109-191). Key changes from blueprint:
   - Accept `locale` parameter (blueprint hardcodes `desc.en`)
   - Use `card.builderClass.desc[locale]` instead of `card.builderClass.desc.en` at line 183
   - Everything else is identical to blueprint
3. Port `downloadCard(card: CardData, locale: "es" | "en"): Promise<void>` — same as blueprint but:
   - Make it async, call `await document.fonts.ready` before `drawCardToCanvas()` (pitfall #1 from research)
   - Pass locale through to `drawCardToCanvas`
4. Add `saveCardToStorage(data: CardData): void` — `localStorage.setItem("spechack_card", JSON.stringify(data))`
5. Add `loadCardFromStorage(): CardData | null` — try/catch parse from localStorage, return null on failure

All functions use named exports (no default export).
  </action>
  <verify>Run `bun run build` — no "window is not defined" or import errors. Verify card-utils.ts has no browser APIs. Verify card-utils.client.ts has "use client" directive.</verify>
  <done>CardData type exportable from card-utils.ts. card-utils.client.ts exists with drawCardToCanvas, downloadCard, saveCardToStorage, loadCardFromStorage — all using "use client" directive to prevent SSR errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create share-utils.ts and add card translations</name>
  <files>src/lib/share-utils.ts, messages/en.json, messages/es.json</files>
  <action>
**share-utils.ts** — Create new file (NO "use client" needed — pure URL string builders):

```typescript
export function buildTweetUrl(text: string): string {
  return `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
}

export function buildWhatsAppUrl(text: string): string {
  return `https://wa.me/?text=${encodeURIComponent(text)}`;
}

export function buildLinkedInUrl(url: string): string {
  return `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
}

export function buildChallengeLink(name: string, origin: string): string {
  return `${origin}/c/${name.split(" ")[0].toLowerCase()}`;
}
```

**messages/en.json** — Add `"cards"` namespace at the end (before closing brace). Use exact text from blueprint `i18n.ts` `t.cards.*`:
```json
"cards": {
  "previewTagline": "Register and get yours",
  "download": "Download Card",
  "shareX": "Share on X",
  "challenge": "Challenge a Friend",
  "challengeCopy": "Copy link",
  "challengeWhatsApp": "WhatsApp",
  "challengeLinkedIn": "LinkedIn",
  "recruitMore": "Want to recruit more? Share your link.",
  "tweetTemplate": "I'm {agent} — {cls}. 10 days, one global hackathon. You in? {link} #SpecHack #404TechFound"
}
```

**messages/es.json** — Add matching `"cards"` namespace:
```json
"cards": {
  "previewTagline": "Registrate y obten la tuya",
  "download": "Descargar Card",
  "shareX": "Compartir en X",
  "challenge": "Reta a un amigo",
  "challengeCopy": "Copiar link",
  "challengeWhatsApp": "WhatsApp",
  "challengeLinkedIn": "LinkedIn",
  "recruitMore": "Quieres reclutar mas? Comparte tu link.",
  "tweetTemplate": "Soy {agent} — {cls}. 10 dias, un hackathon global. Te atreves? {link} #SpecHack #404TechFound"
}
```

Note: Use the exact Spanish text from blueprint `i18n.ts` lines 176-192 for accuracy. The tweetTemplate combines what the blueprint has as separate `tweetEs`/`tweetEn` into a locale-driven single key.
  </action>
  <verify>Run `bun run build` — no errors. Check both JSON files parse correctly. Verify share-utils.ts exports 4 functions.</verify>
  <done>share-utils.ts exports buildTweetUrl, buildWhatsAppUrl, buildLinkedInUrl, buildChallengeLink. Both en.json and es.json have complete "cards" namespace with all card-related translation keys.</done>
</task>

</tasks>

<verification>
1. `bun run build` passes with no errors
2. `bun run lint` passes (Biome formatting — tabs, double quotes)
3. Verify card-utils.ts has CardData export, CITY_FLAGS, getCountryFlag — no browser APIs
4. Verify card-utils.client.ts has "use client", drawCardToCanvas, downloadCard, saveCardToStorage, loadCardFromStorage
5. Verify share-utils.ts has 4 named exports
6. Verify both JSON files have "cards" namespace with matching keys
</verification>

<success_criteria>
- CARD-02 (partial): CardData type defines agent number, name, city, track, builder class, gradient
- CARD-03 (partial): Gradient generation already exists, CardData carries gradient data
- CARD-05 (partial): drawCardToCanvas and downloadCard functions ready for use
- CARD-06 (partial): buildTweetUrl ready, tweetTemplate translation ready
- CARD-07 (partial): buildWhatsAppUrl, buildLinkedInUrl, buildChallengeLink ready
- CARD-09 (partial): saveCardToStorage and loadCardFromStorage ready
</success_criteria>

<output>
After completion, create `.planning/phases/05-trading-cards/05-01-SUMMARY.md`
</output>
