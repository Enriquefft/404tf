---
phase: 07-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/[locale]/_components/RegistrationForm.tsx
  - src/app/[locale]/_components/AmbassadorForm.tsx
  - src/app/[locale]/_actions/register.actions.ts
  - src/app/[locale]/_actions/ambassador.actions.ts
autonomous: true

must_haves:
  truths:
    - "Submit buttons show spinner icon while form is submitting"
    - "Form fields validate on blur with inline error messages"
    - "Server/network errors trigger toast notification"
    - "Ambassador form collapses with animation on success, showing submitted message"
    - "All form inputs preserved after error"
  artifacts:
    - path: "src/app/[locale]/_components/RegistrationForm.tsx"
      provides: "Enhanced registration form with spinner, blur validation, toast errors"
      min_lines: 80
    - path: "src/app/[locale]/_components/AmbassadorForm.tsx"
      provides: "Enhanced ambassador form with spinner, blur validation, collapse animation"
      min_lines: 60
  key_links:
    - from: "RegistrationForm.tsx"
      to: "Toast.tsx"
      via: "useToast hook"
      pattern: "useToast"
    - from: "AmbassadorForm.tsx"
      to: "Toast.tsx"
      via: "useToast hook"
      pattern: "useToast"
    - from: "AmbassadorForm.tsx"
      to: "framer-motion"
      via: "AnimatePresence for collapse"
      pattern: "AnimatePresence"
---

<objective>
Enhance both forms with loading spinners, on-blur field validation, toast notifications for server errors, and animated ambassador form collapse on success.

Purpose: Transform forms from basic submit-and-wait to polished interactive experiences with proper feedback at every stage.

Output: Updated RegistrationForm.tsx and AmbassadorForm.tsx with full UX polish.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish/07-CONTEXT.md
@.planning/phases/07-polish/07-RESEARCH.md
@src/app/[locale]/_components/RegistrationForm.tsx
@src/app/[locale]/_components/AmbassadorForm.tsx
@src/app/[locale]/_actions/register.actions.ts
@src/app/[locale]/_actions/ambassador.actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Improve server action error messages</name>
  <files>
    src/app/[locale]/_actions/register.actions.ts
    src/app/[locale]/_actions/ambassador.actions.ts
  </files>
  <action>
Update both server actions to return more specific error messages that the forms can use to trigger appropriate toast notifications.

**Current pattern (both actions):**
```typescript
catch (error) {
  console.error("...", error);
  return { success: false, message: "error" };
}
```

**Updated pattern:**
```typescript
catch (error) {
  console.error("...", error);
  return { success: false, message: "server_error" };
}
```

The message values should be keys that the form components can use to look up translations:
- `"server_error"` — generic database/server failure
- `"validation_error"` — Zod validation failed (already returns field errors)

**Important:** Keep the existing Zod validation logic, duplicate email handling, and success responses unchanged. Only modify the catch block error message to be a translatable key instead of a generic string.

Also ensure the FormState types include the message field consistently:
- `RegisterFormState`: `{ success: boolean; message: string; errors?: Record<string, string[]>; data?: CardData }`
- `AmbassadorFormState`: `{ success: boolean; message: string; errors?: Record<string, string[]> }`
  </action>
  <verify>
    <command>grep "server_error" 'src/app/[locale]/_actions/register.actions.ts'</command>
    <command>grep "server_error" 'src/app/[locale]/_actions/ambassador.actions.ts'</command>
  </verify>
  <done>
Both server actions return "server_error" message key in catch blocks. FormState types are consistent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance RegistrationForm with spinner, blur validation, and toast</name>
  <files>
    src/app/[locale]/_components/RegistrationForm.tsx
  </files>
  <action>
Update RegistrationForm.tsx with three improvements:

**1. Submit button spinner**

Replace the current "..." pending text with a Loader2 spinner icon:

```tsx
import { Loader2 } from "lucide-react";

// In the submit button:
<button disabled={isPending} ...>
  {isPending ? (
    <Loader2 className="h-5 w-5 animate-spin" />
  ) : (
    translations.submit
  )}
</button>
```

The button should maintain its size when showing the spinner. Keep the button disabled during submission.

**2. On-blur field validation**

Add client-side validation that runs when a user leaves a field (onBlur). Use the existing Zod schema to validate individual fields:

```tsx
import { z } from "zod";

// Define a minimal client-side schema (matching server schema)
const fieldSchemas = {
  name: z.string().min(2),
  email: z.string().email(),
  city: z.string().min(1),
};

// Track client-side field errors
const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({});

const validateField = (field: string, value: string) => {
  const schema = fieldSchemas[field as keyof typeof fieldSchemas];
  if (!schema) return;
  const result = schema.safeParse(value);
  if (!result.success) {
    setFieldErrors((prev) => ({ ...prev, [field]: result.error.errors[0].message }));
  } else {
    setFieldErrors((prev) => {
      const next = { ...prev };
      delete next[field];
      return next;
    });
  }
};
```

Add `onBlur` handlers to each input:
```tsx
<input
  name="name"
  onBlur={(e) => validateField("name", e.target.value)}
  ...
/>
{(fieldErrors.name || state?.errors?.name?.[0]) && (
  <p className="text-red-400 text-xs font-mono">
    {fieldErrors.name || state?.errors?.name?.[0]}
  </p>
)}
```

**3. Toast for server errors**

When the form state indicates a server error (non-field error), show a toast:

```tsx
import { useToast } from "@/app/[locale]/_components/Toast";

const { showToast } = useToast();

// Use useEffect to react to state changes:
useEffect(() => {
  if (state && !state.success && state.message === "server_error") {
    showToast(translations.serverError); // From errors namespace
  }
}, [state]);
```

**Props update:** Add `serverError` to the translations prop:
```typescript
translations: {
  // ...existing
  serverError: string; // From t("errors.registration")
};
```

**Important:** Preserve all existing functionality — card reveal, localStorage, challenge link generation. Only ADD the new UX improvements.
  </action>
  <verify>
    <command>grep "Loader2" 'src/app/[locale]/_components/RegistrationForm.tsx'</command>
    <command>grep "onBlur" 'src/app/[locale]/_components/RegistrationForm.tsx'</command>
    <command>grep "useToast" 'src/app/[locale]/_components/RegistrationForm.tsx'</command>
    <command>grep "animate-spin" 'src/app/[locale]/_components/RegistrationForm.tsx'</command>
  </verify>
  <done>
RegistrationForm has Loader2 spinner on submit button, onBlur validation for name/email/city fields, and toast notification for server errors via useToast hook.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance AmbassadorForm with spinner, blur validation, collapse animation, and toast</name>
  <files>
    src/app/[locale]/_components/AmbassadorForm.tsx
  </files>
  <action>
Update AmbassadorForm.tsx with four improvements:

**1. Submit button spinner**

Same pattern as RegistrationForm — Loader2 icon replacing text while isPending.

**2. On-blur field validation**

Same pattern — validate name, email, city, community fields on blur using partial Zod schemas.

**3. Toast for server errors**

Same pattern — show toast when `state.message === "server_error"`.

**4. Animated collapse on success (CONTEXT.md decision)**

When `state?.success` is true, the form should collapse with animation and be replaced by a success message:

```tsx
import { AnimatePresence, motion } from "framer-motion";

// In JSX:
<AnimatePresence mode="wait">
  {state?.success ? (
    <motion.div
      key="success"
      initial={{ opacity: 0, height: 0 }}
      animate={{ opacity: 1, height: "auto" }}
      className="flex flex-col items-center gap-3 py-8"
    >
      <div className="font-mono text-2xl text-emerald-400">✓</div>
      <p className="font-mono text-sm text-emerald-300">
        {translations.submitted}
      </p>
    </motion.div>
  ) : (
    <motion.form
      key="form"
      exit={{ opacity: 0, height: 0 }}
      transition={{ duration: 0.3 }}
      action={formAction}
      ...
    >
      {/* existing form fields */}
    </motion.form>
  )}
</AnimatePresence>
```

**Props update:** Add `serverError` and `submitted` to translations prop:
```typescript
translations: {
  // ...existing
  serverError: string;  // From t("errors.ambassador")
  submitted: string;    // From t("ambassador.submitted")
};
```

**Important:** Maintain existing CTA collapse behavior (the ambassador form has a "become ambassador" CTA that expands to show the form). The success collapse is a DIFFERENT animation — it's the form itself collapsing after successful submission, not the CTA toggle.
  </action>
  <verify>
    <command>grep "Loader2" 'src/app/[locale]/_components/AmbassadorForm.tsx'</command>
    <command>grep "onBlur" 'src/app/[locale]/_components/AmbassadorForm.tsx'</command>
    <command>grep "useToast" 'src/app/[locale]/_components/AmbassadorForm.tsx'</command>
    <command>grep "AnimatePresence" 'src/app/[locale]/_components/AmbassadorForm.tsx'</command>
    <command>grep "submitted" 'src/app/[locale]/_components/AmbassadorForm.tsx'</command>
  </verify>
  <done>
AmbassadorForm has Loader2 spinner, onBlur validation, toast for server errors, and AnimatePresence collapse animation replacing form with success message on submission.
  </done>
</task>

</tasks>

<verification>
**Spinner in both forms:**
```bash
grep -c "Loader2" 'src/app/[locale]/_components/RegistrationForm.tsx'
grep -c "Loader2" 'src/app/[locale]/_components/AmbassadorForm.tsx'
```

**Blur validation in both forms:**
```bash
grep -c "onBlur" 'src/app/[locale]/_components/RegistrationForm.tsx'
grep -c "onBlur" 'src/app/[locale]/_components/AmbassadorForm.tsx'
```

**Toast integration:**
```bash
grep "useToast" 'src/app/[locale]/_components/RegistrationForm.tsx'
grep "useToast" 'src/app/[locale]/_components/AmbassadorForm.tsx'
```

**Ambassador collapse:**
```bash
grep "AnimatePresence" 'src/app/[locale]/_components/AmbassadorForm.tsx'
```

**Server action error keys:**
```bash
grep "server_error" 'src/app/[locale]/_actions/register.actions.ts'
grep "server_error" 'src/app/[locale]/_actions/ambassador.actions.ts'
```

**Build:**
```bash
bun run build
```
</verification>

<success_criteria>
**Phase 7 Success Criteria Coverage:**
- SC-1 (partial): Forms show loading spinner instead of blank ✓
- SC-3: Disabled button with loading spinner prevents double submissions ✓

**Must-Have Truths Satisfied:**
1. Submit buttons show Loader2 spinner icon while isPending
2. Form fields validate on blur with inline error messages below each field
3. Server/network errors trigger toast notification via useToast
4. Ambassador form collapses with AnimatePresence on success
5. All form inputs preserved after error (useActionState preserves form state)

**Files Modified:**
- src/app/[locale]/_components/RegistrationForm.tsx (spinner, blur validation, toast)
- src/app/[locale]/_components/AmbassadorForm.tsx (spinner, blur validation, toast, collapse)
- src/app/[locale]/_actions/register.actions.ts (error message keys)
- src/app/[locale]/_actions/ambassador.actions.ts (error message keys)
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish/07-02-SUMMARY.md` following the summary template.
</output>
