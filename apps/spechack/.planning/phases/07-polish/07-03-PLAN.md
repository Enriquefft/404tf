---
phase: 07-polish
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - src/lib/card-utils.ts
  - src/lib/card-utils.client.ts
  - src/app/[locale]/c/[name]/page.tsx
  - src/app/[locale]/c/[name]/opengraph-image.tsx
  - src/app/[locale]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Long names (>20 chars) are truncated with ellipsis on trading cards"
    - "Canvas PNG export truncates long names to fit within card boundaries"
    - "OG image truncates long names to prevent overflow"
    - "Invalid challenge URLs (empty/special-chars-only) redirect to home with toast"
    - "Build passes with no errors or hydration warnings"
  artifacts:
    - path: "src/lib/card-utils.ts"
      provides: "truncateName utility function"
      exports: ["truncateName"]
      min_lines: 3
  key_links:
    - from: "TradingCard.tsx"
      to: "card-utils.ts"
      via: "truncateName import"
      pattern: "truncateName"
    - from: "card-utils.client.ts"
      to: "card-utils.ts"
      via: "truncateName import"
      pattern: "truncateName"
    - from: "opengraph-image.tsx"
      to: "card-utils.ts"
      via: "truncateName import"
      pattern: "truncateName"
---

<objective>
Handle production edge cases: name truncation across all card renders, invalid challenge URL validation with redirect, and final build verification.

Purpose: Ensure the app handles real-world edge cases gracefully — long names, malformed URLs, and special characters — for a production-ready experience.

Output: Robust edge case handling across card components and challenge routes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish/07-CONTEXT.md
@.planning/phases/07-polish/07-RESEARCH.md
@src/lib/card-utils.ts
@src/lib/card-utils.client.ts
@src/app/[locale]/_components/TradingCard.tsx
@src/app/[locale]/c/[name]/page.tsx
@src/app/[locale]/c/[name]/opengraph-image.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add truncateName utility to card-utils.ts</name>
  <files>
    src/lib/card-utils.ts
  </files>
  <action>
Add a `truncateName` utility function to `src/lib/card-utils.ts` (the server-safe utils file).

```typescript
/**
 * Truncate name for display on trading cards.
 * Full name preserved in metadata; truncated for visual display only.
 */
export function truncateName(name: string, maxLength = 20): string {
  if (name.length <= maxLength) return name;
  return `${name.slice(0, maxLength)}…`;
}
```

**Why in card-utils.ts:**
- Server-safe (no browser APIs)
- Can be imported by TradingCard, Canvas export, and OG image
- Single source of truth for truncation logic

**Usage:** Apply everywhere a name is displayed visually on cards:
- `TradingCard.tsx` — the `<h3>` element (already has CSS `truncate`, but add explicit truncation for Canvas/OG consistency)
- `card-utils.client.ts` — the Canvas `fillText` call
- `opengraph-image.tsx` — the name `<div>`
  </action>
  <verify>
    <command>grep "truncateName" src/lib/card-utils.ts</command>
    <command>grep "export function truncateName" src/lib/card-utils.ts</command>
  </verify>
  <done>
truncateName function exported from card-utils.ts with default maxLength of 20 and ellipsis character.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply truncateName to Canvas export and OG image</name>
  <files>
    src/lib/card-utils.client.ts
    src/app/[locale]/c/[name]/opengraph-image.tsx
  </files>
  <action>
**Step 1: Canvas export (card-utils.client.ts)**

In the `drawCardToCanvas` function, find where `card.name` is drawn with `fillText` and apply truncation:

```typescript
import { truncateName } from "@/lib/card-utils";

// In drawCardToCanvas, where name is drawn:
ctx.fillText(truncateName(card.name), x, y);
```

This prevents long names from overflowing the Canvas PNG boundaries.

**Step 2: OG image (opengraph-image.tsx)**

In the OG image JSX, truncate the name in the display:

```typescript
import { generateDeterministicCard, truncateName } from "@/lib/card-utils";

// In the JSX where name is rendered:
<div style={{ fontSize: 72, fontFamily: "Orbitron", ... }}>
  {truncateName(card.name)}
</div>
```

This prevents long names from overflowing the 1200x630px OG image.

**Note:** TradingCard.tsx already has CSS `truncate` class which handles visual overflow. The explicit truncateName is most critical for Canvas and OG where CSS truncation doesn't apply.
  </action>
  <verify>
    <command>grep "truncateName" src/lib/card-utils.client.ts</command>
    <command>grep "truncateName" 'src/app/[locale]/c/[name]/opengraph-image.tsx'</command>
  </verify>
  <done>
Canvas export and OG image both use truncateName for long name handling. Canvas fillText won't overflow. OG image won't overflow 1200px width.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add invalid challenge URL validation with redirect</name>
  <files>
    src/app/[locale]/c/[name]/page.tsx
  </files>
  <action>
Add validation to the challenge page to handle invalid name parameters.

**Invalid cases to handle:**
1. Empty name after decoding (e.g., `/c/` — though routing may catch this)
2. Name containing only special characters or whitespace
3. Name that decodes to empty string

**Implementation in page.tsx:**

At the top of the page component, after decoding the name:

```typescript
import { redirect } from "next/navigation";

export default async function ChallengePage({ params }: Props) {
  const { locale, name } = await params;
  const decodedName = decodeURIComponent(name);

  // Validate: name must contain at least one alphanumeric character
  const isValidName = /\p{L}/u.test(decodedName.trim());
  if (!isValidName) {
    redirect(`/${locale}`);
  }

  // ... rest of page
}
```

**Why `\p{L}` (Unicode Letter):**
- Accepts names in any script (Latin, Cyrillic, Arabic, CJK, etc.)
- Rejects strings that are only punctuation, numbers, or whitespace
- More inclusive than `[a-zA-Z]`

**For generateMetadata:**
Add the same validation in `generateMetadata` to prevent invalid OG metadata:

```typescript
export async function generateMetadata({ params }: Props) {
  const { locale, name } = await params;
  const decodedName = decodeURIComponent(name);

  const isValidName = /\p{L}/u.test(decodedName.trim());
  if (!isValidName) {
    return { title: "SpecHack 2026" }; // Fallback metadata before redirect
  }

  // ... rest of metadata generation
}
```

**Note on toast:** The CONTEXT.md says "toast + redirect". Since the redirect happens server-side and the toast system is client-side, the toast won't show during SSR redirect. This is acceptable — the redirect itself is clear enough feedback. If we wanted toast, we'd need client-side validation which adds unnecessary complexity for an edge case.
  </action>
  <verify>
    <command>grep "isValidName" 'src/app/[locale]/c/[name]/page.tsx'</command>
    <command>grep "redirect" 'src/app/[locale]/c/[name]/page.tsx'</command>
    <command>grep "\\\\p{L}" 'src/app/[locale]/c/[name]/page.tsx'</command>
  </verify>
  <done>
Challenge page validates name parameter with Unicode letter check. Invalid names redirect to home. generateMetadata returns fallback for invalid names.
  </done>
</task>

<task type="auto">
  <name>Task 4: Final build verification and translation prop updates</name>
  <files>
    src/app/[locale]/page.tsx
  </files>
  <action>
**Step 1: Update page.tsx to pass new translation props**

The page.tsx composition root needs to pass the new error/success translation strings to RegistrationForm and the Hubs section (which contains AmbassadorForm).

Add the new translation props where RegistrationForm and AmbassadorForm receive their translations:

For RegistrationForm:
```typescript
const errorsT = await getTranslations("errors");
// Add to RegistrationForm translations prop:
serverError: errorsT("registration"),
```

For AmbassadorForm (passed through Hubs or directly):
```typescript
serverError: errorsT("ambassador"),
submitted: ambassadorT("submitted"),
```

**Step 2: Full build verification**

```bash
bun run build
```

Must pass with:
- No TypeScript errors
- No missing translation keys
- No hydration warnings
- All routes compile successfully

**Step 3: Lint check**

```bash
bun run lint
```

Must pass Biome checks.
  </action>
  <verify>
    <command>bun run build 2>&1 | tail -20</command>
    <command>bun run lint 2>&1 | tail -10</command>
  </verify>
  <done>
Build passes with no errors. Lint passes. All translation props correctly threaded through composition root. No hydration warnings.
  </done>
</task>

</tasks>

<verification>
**truncateName utility:**
```bash
grep "export function truncateName" src/lib/card-utils.ts
```

**Name truncation applied:**
```bash
grep "truncateName" src/lib/card-utils.client.ts
grep "truncateName" 'src/app/[locale]/c/[name]/opengraph-image.tsx'
```

**Invalid URL validation:**
```bash
grep "isValidName" 'src/app/[locale]/c/[name]/page.tsx'
grep "redirect" 'src/app/[locale]/c/[name]/page.tsx'
```

**Build + lint:**
```bash
bun run build
bun run lint
```
</verification>

<success_criteria>
**Phase 7 Success Criteria Coverage:**
- SC-4: Smooth animations (no changes needed — existing animations are performant) ✓
- SC-5: No hydration warnings in production build ✓

**Must-Have Truths Satisfied:**
1. Long names truncated with ellipsis at 20 chars on trading cards
2. Canvas PNG export uses truncateName to prevent overflow
3. OG image uses truncateName to prevent overflow
4. Invalid challenge URLs redirect to home page
5. Build passes with no errors, no hydration warnings

**Files Modified:**
- src/lib/card-utils.ts (truncateName function)
- src/lib/card-utils.client.ts (Canvas truncation)
- src/app/[locale]/c/[name]/opengraph-image.tsx (OG truncation)
- src/app/[locale]/c/[name]/page.tsx (invalid URL validation)
- src/app/[locale]/page.tsx (translation prop threading)
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish/07-03-SUMMARY.md` following the summary template.
Update `.planning/STATE.md` to mark Phase 7 complete.
Update `.planning/ROADMAP.md` to check off Phase 7.
</output>
