---
phase: 06-challenge-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/card-utils.ts
  - src/lib/share-utils.ts
  - messages/en.json
  - messages/es.json
autonomous: true

must_haves:
  truths:
    - "User visiting /es/c/Maria or /en/c/Maria sees deterministic card (same gradient, builder class, agent number)"
    - "Challenge link includes locale prefix (/es/c/... or /en/c/...)"
    - "Challenge translations exist in both ES and EN"
  artifacts:
    - path: "src/lib/card-utils.ts"
      provides: "generateDeterministicCard function with hash-based agent number"
      exports: ["generateDeterministicCard", "PLACEHOLDER_AGENT_NUMBER"]
      min_lines: 15
    - path: "src/lib/share-utils.ts"
      provides: "Updated buildChallengeLink with locale parameter"
      exports: ["buildChallengeLink"]
      contains: "locale"
    - path: "messages/en.json"
      provides: "Challenge namespace translations"
      contains: "challenge"
    - path: "messages/es.json"
      provides: "Challenge namespace translations"
      contains: "challenge"
  key_links:
    - from: "generateDeterministicCard"
      to: "getDeterministicBuilderClass + generateCardGradient"
      via: "function composition"
      pattern: "getDeterministicBuilderClass.*generateCardGradient"
    - from: "buildChallengeLink"
      to: "locale parameter"
      via: "URL construction"
      pattern: "\\$\\{origin\\}/\\$\\{locale\\}/c/"
---

<objective>
Extend card utilities and share functions to support deterministic challenge card generation and locale-aware challenge URLs, plus add bilingual challenge page translations.

Purpose: Prepare foundation for challenge pages (/c/[name]) with consistent card previews and proper i18n routing.

Output: Server-safe card generation function, updated share URL builder, complete challenge translations in both languages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-challenge-system/06-RESEARCH.md
@.planning/phases/05-trading-cards/05-01-SUMMARY.md
@src/lib/card-utils.ts
@src/lib/share-utils.ts
@messages/en.json
@messages/es.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generateDeterministicCard() to card-utils.ts</name>
  <files>
    src/lib/card-utils.ts
  </files>
  <action>
Extend card-utils.ts with deterministic card generation function for challenge pages.

**Add constant:**
```typescript
export const PLACEHOLDER_AGENT_NUMBER = "SPEC-????";
```

**Add function after existing getDeterministicBuilderClass():**
```typescript
/**
 * Generate a deterministic trading card from a name alone (for challenge pages).
 * Does not require database lookup. Always produces same card for same name.
 * Uses hash-based agent number for consistent preview.
 */
export function generateDeterministicCard(name: string): CardData {
  // Capitalize first letter of each word for display
  const displayName = name
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(" ");

  // Generate deterministic 4-digit agent number from hash
  const hash = hashStr(displayName);
  const agentNum = (hash % 9000) + 1000; // Range: 1000-9999

  return {
    agentNumber: `SPEC-${agentNum.toString().padStart(4, "0")}`,
    name: displayName,
    city: "Virtual",
    track: "virtual" as const,
    builderClass: getDeterministicBuilderClass(displayName),
    gradient: generateCardGradient(displayName),
  };
}
```

**Rationale:** Hash-based agent number (not "SPEC-????") creates more complete-looking preview cards while remaining fully deterministic. Uses existing hashStr(), getDeterministicBuilderClass(), and generateCardGradient() functions.
  </action>
  <verify>
    <command>grep -A 20 "export function generateDeterministicCard" src/lib/card-utils.ts</command>
    <command>grep "PLACEHOLDER_AGENT_NUMBER" src/lib/card-utils.ts</command>
    <command>bun run build</command>
  </verify>
  <done>
generateDeterministicCard() function exists, exports CardData type, uses hash-based agent number formula, capitalizes display name, returns all required CardData fields. Build passes with no TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update buildChallengeLink() and add challenge translations</name>
  <files>
    src/lib/share-utils.ts
    messages/en.json
    messages/es.json
  </files>
  <action>
**Part A: Update share-utils.ts**

Replace existing `buildChallengeLink()` function:
```typescript
export function buildChallengeLink(
  name: string,
  origin: string,
  locale: "es" | "en"
): string {
  // Use first word only, lowercase, URL-encoded
  const slug = encodeURIComponent(name.split(" ")[0].toLowerCase());
  return `${origin}/${locale}/c/${slug}`;
}
```

**Why:** Adds locale prefix for i18n routing (/es/c/... or /en/c/...), properly encodes names for URL safety.

**Part B: Add challenge namespace to messages/en.json**

Add after "cards" namespace:
```json
"challenge": {
  "title": "{name} challenges you to join SpecHack",
  "prompt": "Do you accept the challenge? Register and get your own trading card.",
  "registerCta": "Accept Challenge",
  "metaTitle": "Join {name} at SpecHack 2026",
  "metaDescription": "{name} challenges you to join SpecHack 2026 — 10 days, one global hackathon. Register and get your trading card."
}
```

**Part C: Add challenge namespace to messages/es.json**

Add after "cards" namespace:
```json
"challenge": {
  "title": "{name} te desafía a unirte a SpecHack",
  "prompt": "¿Aceptas el desafío? Regístrate y obtén tu propia tarjeta.",
  "registerCta": "Aceptar Desafío",
  "metaTitle": "Únete a {name} en SpecHack 2026",
  "metaDescription": "{name} te desafía a unirte a SpecHack 2026 — 10 días, un hackathon global. Regístrate y obtén tu tarjeta."
}
```
  </action>
  <verify>
    <command>grep -A 3 "export function buildChallengeLink" src/lib/share-utils.ts</command>
    <command>grep '"challenge":' messages/en.json</command>
    <command>grep '"challenge":' messages/es.json</command>
    <command>bun run lint</command>
  </verify>
  <done>
buildChallengeLink() signature includes locale parameter, function uses encodeURIComponent(), URL format is ${origin}/${locale}/c/${slug}. Both en.json and es.json have "challenge" namespace with all 5 keys (title, prompt, registerCta, metaTitle, metaDescription). Biome lint passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CardReveal to pass locale to buildChallengeLink()</name>
  <files>
    src/app/[locale]/_components/CardReveal.tsx
  </files>
  <action>
Update all calls to `buildChallengeLink()` in CardReveal.tsx to include locale parameter.

**Find and replace pattern:**
- OLD: `buildChallengeLink(card.name, window.location.origin)`
- NEW: `buildChallengeLink(card.name, window.location.origin, locale)`

**Affected locations:**
1. Copy to clipboard handler (challengeLink variable)
2. WhatsApp share URL builder
3. LinkedIn share URL builder

**Verify:** CardReveal.tsx already has `locale` prop from Phase 5 integration. No new props needed.
  </action>
  <verify>
    <command>grep -n "buildChallengeLink" src/app/[locale]/_components/CardReveal.tsx</command>
    <command>bun run build</command>
  </verify>
  <done>
All buildChallengeLink() calls in CardReveal.tsx pass 3 arguments: (card.name, window.location.origin, locale). Build passes with no TypeScript errors.
  </done>
</task>

</tasks>

<verification>
**Test deterministic generation:**
```bash
# Create test file (optional - for manual verification)
echo 'import { generateDeterministicCard } from "./src/lib/card-utils";
console.log(JSON.stringify(generateDeterministicCard("Maria"), null, 2));
console.log(JSON.stringify(generateDeterministicCard("Maria"), null, 2));
console.log(JSON.stringify(generateDeterministicCard("John"), null, 2));' > test-deterministic.ts

bun run test-deterministic.ts
# Should show: Maria produces identical CardData twice, John produces different but consistent data
```

**Test challenge link format:**
```bash
# Verify locale prefix in URL pattern
grep -A 5 'buildChallengeLink' src/lib/share-utils.ts | grep '${locale}'
```

**Build verification:**
```bash
bun run build  # Must pass
bun run lint   # Must pass
```
</verification>

<success_criteria>
**Requirement Coverage:**
- CHAL-01: ✓ Deterministic card generation function created
- CHAL-02: ✓ Locale-aware challenge URLs implemented
- SEO-02: ✓ Challenge translations prepared for dynamic metadata

**Must-Have Truths Satisfied:**
1. generateDeterministicCard("Maria") produces same CardData on every call (hash-based agent number, deterministic gradient, deterministic builder class)
2. buildChallengeLink("Maria", origin, "es") returns ${origin}/es/c/maria
3. buildChallengeLink("María José", origin, "en") returns ${origin}/en/c/mar%C3%ADa (URL-encoded)
4. Both messages/en.json and messages/es.json contain "challenge" namespace with 5 translation keys

**Files Modified:**
- src/lib/card-utils.ts (added generateDeterministicCard, PLACEHOLDER_AGENT_NUMBER)
- src/lib/share-utils.ts (updated buildChallengeLink signature)
- src/app/[locale]/_components/CardReveal.tsx (updated buildChallengeLink calls)
- messages/en.json (added challenge namespace)
- messages/es.json (added challenge namespace)
</success_criteria>

<output>
After completion, create `.planning/phases/06-challenge-system/06-01-SUMMARY.md` following the summary template.
</output>
