---
phase: 06-challenge-system
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - public/fonts/Orbitron-Bold.ttf
  - public/fonts/JetBrainsMono-Regular.ttf
  - src/app/[locale]/c/[name]/opengraph-image.tsx
autonomous: true

must_haves:
  truths:
    - "User sharing /c/[name] link on X shows dynamic OG image with challenger's card"
    - "OG image renders at 1200x630px with trading card visual"
    - "OG image uses custom fonts (Orbitron, JetBrains Mono)"
    - "OG image shows challenger name, agent number, builder class, gradient background"
  artifacts:
    - path: "public/fonts/Orbitron-Bold.ttf"
      provides: "Font file for OG image rendering"
      min_size: 1000
    - path: "public/fonts/JetBrainsMono-Regular.ttf"
      provides: "Font file for OG image rendering"
      min_size: 1000
    - path: "src/app/[locale]/c/[name]/opengraph-image.tsx"
      provides: "Dynamic OG image route using ImageResponse"
      exports: ["default", "runtime", "size", "contentType", "alt"]
      min_lines: 100
  key_links:
    - from: "opengraph-image.tsx"
      to: "generateDeterministicCard"
      via: "import and function call"
      pattern: "generateDeterministicCard\\(decodedName\\)"
    - from: "opengraph-image.tsx"
      to: "public/fonts/*.ttf"
      via: "fetch with new URL()"
      pattern: "new URL\\(.*fonts.*ttf"
    - from: "opengraph-image.tsx"
      to: "ImageResponse"
      via: "next/og import"
      pattern: "ImageResponse"
---

<objective>
Create dynamic Open Graph image route that renders challenger's trading card as 1200x630px PNG for social media previews using Next.js ImageResponse.

Purpose: Enable viral sharing with rich previews. When users share challenge links on X, WhatsApp, or LinkedIn, the preview shows the challenger's unique trading card.

Output: Working OG image route with custom font rendering and Satori-compatible flexbox layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-challenge-system/06-RESEARCH.md
@src/lib/card-utils.ts
@src/app/[locale]/_components/TradingCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download custom fonts to public/fonts/</name>
  <files>
    public/fonts/Orbitron-Bold.ttf
    public/fonts/JetBrainsMono-Regular.ttf
  </files>
  <action>
Download Orbitron and JetBrains Mono font files from Google Fonts for use in ImageResponse.

**Why needed:** ImageResponse (Satori) requires font files as ArrayBuffers. Cannot use web fonts or CSS font families.

**Download sources:**
1. **Orbitron Bold:** https://github.com/google/fonts/raw/main/ofl/orbitron/static/Orbitron-Bold.ttf
2. **JetBrains Mono Regular:** https://github.com/JetBrains/JetBrainsMono/raw/master/fonts/ttf/JetBrainsMono-Regular.ttf

**Commands:**
```bash
mkdir -p public/fonts
curl -L "https://github.com/google/fonts/raw/main/ofl/orbitron/static/Orbitron-Bold.ttf" -o public/fonts/Orbitron-Bold.ttf
curl -L "https://github.com/JetBrains/JetBrainsMono/raw/master/fonts/ttf/JetBrainsMono-Regular.ttf" -o public/fonts/JetBrainsMono-Regular.ttf
```

**Verification:** Both files should be ~100-200KB each.

**Licensing:** Both fonts are open source (OFL). Bundling is permitted and recommended for reliability.
  </action>
  <verify>
    <command>test -f public/fonts/Orbitron-Bold.ttf</command>
    <command>test -f public/fonts/JetBrainsMono-Regular.ttf</command>
    <command>ls -lh public/fonts/*.ttf</command>
  </verify>
  <done>
Both font files exist in public/fonts/ directory. Orbitron-Bold.ttf is ~100-200KB. JetBrainsMono-Regular.ttf is ~100-200KB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create opengraph-image.tsx with ImageResponse</name>
  <files>
    src/app/[locale]/c/[name]/opengraph-image.tsx
  </files>
  <action>
Create dynamic OG image route at `src/app/[locale]/c/[name]/opengraph-image.tsx` using Next.js ImageResponse.

**File structure:**
```typescript
import { ImageResponse } from "next/og";
import { generateDeterministicCard } from "@/lib/card-utils";

export const runtime = "edge"; // Required for ImageResponse
export const alt = "SpecHack Challenge Card";
export const size = { width: 1200, height: 630 }; // OG standard
export const contentType = "image/png";

type Props = {
  params: Promise<{ locale: string; name: string }>;
};

export default async function Image({ params }: Props) {
  const { locale, name } = await params;
  const decodedName = decodeURIComponent(name);
  const card = generateDeterministicCard(decodedName);

  // Load custom fonts (must use fetch with absolute URLs in Edge runtime)
  const [orbitronBold, jetbrainsMonoReg] = await Promise.all([
    fetch(new URL("../../../../public/fonts/Orbitron-Bold.ttf", import.meta.url))
      .then((res) => res.arrayBuffer()),
    fetch(new URL("../../../../public/fonts/JetBrainsMono-Regular.ttf", import.meta.url))
      .then((res) => res.arrayBuffer()),
  ]);

  return new ImageResponse(
    (
      <div
        style={{
          display: "flex",
          width: "100%",
          height: "100%",
          background: `linear-gradient(${card.gradient.angle}deg, ${card.gradient.from}20, ${card.gradient.to}20), hsl(240,10%,7%)`,
          padding: 60,
          flexDirection: "column",
          justifyContent: "space-between",
        }}
      >
        {/* Top section: Logo + Agent # */}
        <div style={{ display: "flex", flexDirection: "column" }}>
          <div
            style={{
              fontSize: 28,
              fontFamily: "JetBrains Mono",
              color: "hsl(240,5%,50%)",
              letterSpacing: "0.1em",
            }}
          >
            SPECHACK 2026
          </div>
          <div
            style={{
              fontSize: 72,
              fontFamily: "Orbitron",
              fontWeight: 700,
              color: "white",
              marginTop: 20,
            }}
          >
            {card.name}
          </div>
          <div
            style={{
              fontSize: 48,
              fontFamily: "JetBrains Mono",
              color: card.gradient.from,
              marginTop: 10,
            }}
          >
            {card.agentNumber}
          </div>
        </div>

        {/* Bottom section: Builder class + CTA */}
        <div style={{ display: "flex", flexDirection: "column" }}>
          <div
            style={{
              fontSize: 40,
              fontFamily: "Orbitron",
              fontWeight: 700,
              color: card.gradient.to,
            }}
          >
            {card.builderClass.name}
          </div>
          <div
            style={{
              fontSize: 28,
              fontFamily: "JetBrains Mono",
              color: "hsl(240,5%,60%)",
              marginTop: 10,
            }}
          >
            {card.builderClass.desc[locale as "es" | "en"]}
          </div>
          <div
            style={{
              fontSize: 24,
              fontFamily: "JetBrains Mono",
              color: "hsl(240,5%,40%)",
              marginTop: 40,
            }}
          >
            Join the challenge · June 19-28, 2026
          </div>
        </div>
      </div>
    ),
    {
      ...size,
      fonts: [
        { name: "Orbitron", data: orbitronBold, weight: 700, style: "normal" },
        { name: "JetBrains Mono", data: jetbrainsMonoReg, weight: 400, style: "normal" },
      ],
    }
  );
}
```

**Critical constraints (Satori limitations):**
1. **Flexbox only** — No CSS Grid, no `display: grid`
2. **Inline styles only** — No className with Tailwind utilities
3. **Limited CSS** — No `backdrop-filter`, `transform`, `animation`, `calc()`
4. **Font loading** — Must use `fetch()` with `new URL()` (not fs.readFileSync)
5. **Edge runtime** — Must export `runtime = "edge"`

**Visual layout:**
- Dark background with gradient overlay (15% opacity like trading card)
- Top: Logo text, name, agent number
- Bottom: Builder class name, description (locale-aware), event CTA
- Uses card gradient colors for accents

**Why this approach:**
- Matches trading card visual style
- Works within Satori's CSS subset
- Reuses generateDeterministicCard() (same card as page)
- Locale-aware builder class description
  </action>
  <verify>
    <command>test -f src/app/[locale]/c/[name]/opengraph-image.tsx</command>
    <command>grep "export const runtime = \"edge\"" src/app/[locale]/c/[name]/opengraph-image.tsx</command>
    <command>grep "ImageResponse" src/app/[locale]/c/[name]/opengraph-image.tsx</command>
    <command>grep "generateDeterministicCard" src/app/[locale]/c/[name]/opengraph-image.tsx</command>
    <command>grep "new URL.*fonts.*ttf" src/app/[locale]/c/[name]/opengraph-image.tsx</command>
    <command>bun run build</command>
  </verify>
  <done>
File exists at src/app/[locale]/c/[name]/opengraph-image.tsx. Exports runtime="edge", size, contentType, alt, and default Image function. Uses ImageResponse from next/og. Calls generateDeterministicCard(). Loads fonts via fetch + new URL(). Uses only flexbox layout with inline styles. Build passes with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test OG image generation</name>
  <files>
    (no file changes - verification only)
  </files>
  <action>
Build and verify OG images generate correctly for challenge routes.

**Test approach:**
After successful build, Next.js auto-links opengraph-image.tsx to page.tsx metadata. The page.tsx generateMetadata() from Plan 06-02 already includes openGraph config.

**Expected behavior:**
1. Build generates static OG image routes
2. Visiting `/es/c/maria/opengraph-image` returns PNG (can test in browser after dev server start)
3. Social media platforms detect og:image meta tag automatically
4. OG image shows Maria's deterministic card visual

**Build verification:**
```bash
bun run build
# Should show: Route (app) compiled successfully
# Should NOT show: Font loading errors, Satori CSS errors, edge runtime errors
```

**Manual verification (optional after build):**
```bash
bun run dev
# Visit: http://localhost:3000/es/c/maria/opengraph-image
# Should return: PNG image (1200x630) with trading card visual
```
  </action>
  <verify>
    <command>bun run build 2>&1 | grep -i "error" && exit 1 || exit 0</command>
    <command>grep "export.*runtime.*edge" src/app/[locale]/c/[name]/opengraph-image.tsx</command>
    <command>grep "export.*size.*1200.*630" src/app/[locale]/c/[name]/opengraph-image.tsx</command>
  </verify>
  <done>
Build succeeds with no errors. opengraph-image.tsx exports runtime="edge" and size={width:1200,height:630}. No font loading errors. No Satori CSS errors. Route compiles successfully.
  </done>
</task>

</tasks>

<verification>
**Font files check:**
```bash
ls -lh public/fonts/
# Should show: Orbitron-Bold.ttf (~100-200KB), JetBrainsMono-Regular.ttf (~100-200KB)
```

**OG image route structure:**
```bash
ls -la src/app/[locale]/c/[name]/
# Should show: page.tsx, opengraph-image.tsx
```

**Edge runtime export:**
```bash
grep "export const runtime" src/app/[locale]/c/[name]/opengraph-image.tsx
# Should return: export const runtime = "edge";
```

**ImageResponse usage:**
```bash
grep -c "ImageResponse" src/app/[locale]/c/[name]/opengraph-image.tsx
# Should return: 2 (import + new ImageResponse)
```

**Build verification:**
```bash
bun run build
# Must pass with no errors
# Must not show font loading failures
# Must not show Satori CSS warnings
```
</verification>

<success_criteria>
**Requirement Coverage:**
- CHAL-04: ✓ Dynamic OG image shows challenger's card
- SEO-03: ✓ Social media previews work for challenge links

**Must-Have Truths Satisfied:**
1. Font files exist in public/fonts/ (Orbitron-Bold.ttf, JetBrainsMono-Regular.ttf)
2. opengraph-image.tsx exists with runtime="edge" export
3. OG image renders at 1200x630px (standard OpenGraph size)
4. OG image uses custom fonts loaded via fetch()
5. OG image displays challenger name, agent number, builder class, gradient background
6. OG image uses locale-aware builder class description
7. generateDeterministicCard() produces same card visual as challenge page

**Technical Validation:**
- ImageResponse compiles without Satori CSS errors
- Fonts load correctly in Edge runtime (no fs errors)
- Only flexbox layout used (no Grid)
- Inline styles only (no Tailwind classes)
- gradientangle and colors applied correctly

**Files Created:**
- public/fonts/Orbitron-Bold.ttf
- public/fonts/JetBrainsMono-Regular.ttf
- src/app/[locale]/c/[name]/opengraph-image.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/06-challenge-system/06-03-SUMMARY.md` following the summary template.
</output>
