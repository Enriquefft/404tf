---
phase: 03-interactive-components
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/[locale]/_actions/intent.actions.ts
  - src/app/[locale]/_components/IntentCTA.tsx
  - src/app/[locale]/page.tsx
  - messages/es.json
  - messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can select one of 3 intent cards (Build/Collaborate/Connect)"
    - "Selected card is visually highlighted with scale and border change"
    - "Form validates name (min 2 chars) and email (valid format) with Zod"
    - "Submitting form with valid data inserts a row into intent_submissions table"
    - "Success message displays after successful submission"
    - "Validation errors display inline below their respective fields"
    - "IntentCTA section preserves gradient-purple background and decorative grid"
    - "Intent cards animate on selection via Framer Motion"
  artifacts:
    - path: "src/app/[locale]/_actions/intent.actions.ts"
      provides: "Server Action for intent form submission"
      contains: "use server"
      exports: ["submitIntent"]
    - path: "src/app/[locale]/_components/IntentCTA.tsx"
      provides: "Interactive intent form with card selection"
      contains: "use client"
  key_links:
    - from: "IntentCTA.tsx"
      to: "intent.actions.ts"
      via: "useActionState hook"
      pattern: "useActionState.*submitIntent"
    - from: "intent.actions.ts"
      to: "src/db/schema.ts"
      via: "Drizzle insert"
      pattern: "db\\.insert.*intentSubmissions"
    - from: "intent.actions.ts"
      to: "zod"
      via: "schema validation"
      pattern: "z\\.object"
    - from: "page.tsx"
      to: "IntentCTA.tsx"
      via: "locale and translations props"
      pattern: "locale={locale}"
---

<objective>
Create the Server Action for intent form submission and convert IntentCTA from a static Server Component to an interactive Client Component with card selection, form fields, Zod validation, and database persistence via useActionState.

Purpose: The intent form is the primary conversion mechanism of the landing page. Visitors select their intent (Build/Collaborate/Connect), enter their name and email, and submit. The data persists to the Neon Postgres database for follow-up.

Output: A Server Action with Zod validation and Drizzle insert, an interactive IntentCTA Client Component with useActionState, card selection animations, inline error display, and success state.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-interactive-components/03-RESEARCH.md
@.planning/phases/03-interactive-components/03-02-SUMMARY.md
@src/db/schema.ts
@src/app/[locale]/_components/IntentCTA.tsx
@src/app/[locale]/page.tsx
@messages/es.json
@messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action for intent form submission</name>
  <files>
    src/app/[locale]/_actions/intent.actions.ts
    messages/es.json
    messages/en.json
  </files>
  <action>
    1. Create `src/app/[locale]/_actions/` directory.

    2. Create `intent.actions.ts` with "use server" directive:
       - Import `z` from `zod`
       - Import `db` from `@/db`
       - Import `intentSubmissions` from `@/db/schema`
       - Define Zod schema:
         ```
         const intentSchema = z.object({
           intent: z.enum(["build", "collaborate", "connect"]),
           name: z.string().min(2, "Name must be at least 2 characters"),
           email: z.string().email("Invalid email address"),
           locale: z.enum(["es", "en"]),
         });
         ```
       - Define `FormState` type:
         ```
         type FormState = {
           success: boolean;
           message: string;
           errors?: {
             intent?: string[];
             name?: string[];
             email?: string[];
           };
         } | null;
         ```
       - Export `submitIntent` function:
         ```
         export async function submitIntent(
           prevState: FormState,
           formData: FormData
         ): Promise<FormState>
         ```
       - Parse formData fields: intent, name, email, locale
       - Validate with `intentSchema.safeParse()`
       - On validation failure: return `{ success: false, message: "Validation failed", errors: flattenedFieldErrors }`
       - On success: `await db.insert(intentSubmissions).values(validatedFields.data)`
       - On DB success: return `{ success: true, message: "success" }`
       - On DB error: catch, log error, return `{ success: false, message: "Database error. Please try again." }`
       - The `message: "success"` key will be used client-side to look up the translated success message from props

    3. Add form validation error translation keys to both `messages/es.json` and `messages/en.json` under `landing.intent`:
       - Add keys: `errorName`, `errorEmail`, `errorIntent`, `errorGeneric`, `submitting`
       - ES: `"errorName": "El nombre debe tener al menos 2 caracteres"`, `"errorEmail": "Email inv√°lido"`, `"errorIntent": "Selecciona una opci√≥n"`, `"errorGeneric": "Error al enviar. Intenta de nuevo."`, `"submitting": "Enviando..."`
       - EN: `"errorName": "Name must be at least 2 characters"`, `"errorEmail": "Invalid email address"`, `"errorIntent": "Please select an option"`, `"errorGeneric": "Submission failed. Please try again."`, `"submitting": "Submitting..."`

    Use tabs + double quotes. Follow 03-RESEARCH.md Pattern 5 (Server Actions with useActionState and Zod).
  </action>
  <verify>
    - `bunx biome check src/app/[locale]/_actions/` passes
    - `bunx tsc --noEmit` passes (Server Action types are correct)
    - Function signature matches useActionState contract: `(prevState, formData) => Promise<FormState>`
  </verify>
  <done>
    Server Action `submitIntent` exists with Zod validation, Drizzle insert, and proper FormState return type. Translation files updated with error message keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert IntentCTA to interactive Client Component with form</name>
  <files>
    src/app/[locale]/_components/IntentCTA.tsx
    src/app/[locale]/page.tsx
  </files>
  <action>
    **IntentCTA.tsx ‚Äî Convert to Client Component with useActionState form:**

    1. Add "use client" directive. Remove `async` keyword. Remove `getTranslations` import.
    2. Accept props:
       ```
       {
         locale: "es" | "en";
         translations: {
           headline: string;
           subtitle: string;
           build: string;
           collaborate: string;
           connect: string;
           name: string;
           email: string;
           buildSubmit: string;
           collaborateSubmit: string;
           connectSubmit: string;
           buildHelper: string;
           collaborateHelper: string;
           connectHelper: string;
           success: string;
           questions: string;
           errorName: string;
           errorEmail: string;
           errorIntent: string;
           errorGeneric: string;
           submitting: string;
         };
       }
       ```
    3. Import `useActionState` and `useState` from `react`
    4. Import `submitIntent` from `../_actions/intent.actions`
    5. Import `motion` and `AnimatePresence` from `framer-motion`
    6. Import `clsx` from `clsx`
    7. Set up form state:
       - `const [state, formAction, isPending] = useActionState(submitIntent, null)`
       - `const [selectedIntent, setSelectedIntent] = useState<"build" | "collaborate" | "connect" | null>(null)`
    8. Define intents array (same as existing but typed):
       ```
       const intents = [
         { key: "build" as const, emoji: "üî¨" },
         { key: "collaborate" as const, emoji: "ü§ù" },
         { key: "connect" as const, emoji: "üåê" },
       ] as const;
       ```
    9. Build the form UI inside the existing section structure:
       - **Preserve** the section id="intent-cta", gradient-purple class, decorative grid div, container structure, headline, subtitle, and contact section at bottom
       - Replace static intent cards with interactive ones:
         - Wrap cards in `<form action={formAction}>` with hidden inputs for locale and intent
         - Each card is a `<button type="button">` (not submit) with onClick to set selectedIntent
         - Selected card: `border-white/60 bg-white/20 scale-105` + Framer Motion `layoutId` or `animate` for smooth transition
         - Unselected: `border-white/20 bg-white/10 hover:bg-white/15`
         - Use `motion.button` for card animation on selection:
           ```
           <motion.button
             whileTap={{ scale: 0.97 }}
             animate={selectedIntent === intent.key ? { scale: 1.05, borderColor: "rgba(255,255,255,0.6)" } : { scale: 1 }}
             transition={{ type: "spring", stiffness: 300, damping: 20 }}
           >
           ```
       - After cards, show dynamic submit button text and helper text based on selectedIntent:
         - If `selectedIntent === "build"`: submit shows `translations.buildSubmit`, helper shows `translations.buildHelper`
         - If `selectedIntent === "collaborate"`: submit shows `translations.collaborateSubmit`, helper shows `translations.collaborateHelper`
         - If `selectedIntent === "connect"`: submit shows `translations.connectSubmit`, helper shows `translations.connectHelper`
       - Add name input field:
         - `<input type="text" name="name" placeholder={translations.name} required />`
         - Style: `w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-white/30`
         - Error display below: show `translations.errorName` if `state?.errors?.name`
       - Add email input field:
         - `<input type="email" name="email" placeholder={translations.email} required />`
         - Same styling as name
         - Error display below: show `translations.errorEmail` if `state?.errors?.email`
       - Add hidden inputs:
         - `<input type="hidden" name="locale" value={locale} />`
         - `<input type="hidden" name="intent" value={selectedIntent || ""} />`
       - Add submit button:
         - Disabled when `isPending` or `!selectedIntent`
         - Show `translations.submitting` when isPending
         - Style: enabled ‚Üí `bg-white text-purple-600 hover:opacity-90`, disabled ‚Üí `bg-white/20 cursor-not-allowed opacity-50`
       - Show intent validation error if `state?.errors?.intent`: display `translations.errorIntent`
    10. Handle success state:
        - If `state?.success === true`, show success message instead of form:
          ```
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
          >
            <p className="text-xl text-white font-semibold">{translations.success}</p>
          </motion.div>
          ```
        - Keep the headline, subtitle, and contact section visible even after success
    11. Show generic error: if `state?.success === false && !state?.errors`, display `translations.errorGeneric`

    **page.tsx ‚Äî Pass locale and translations to IntentCTA:**

    1. Fetch intent translations: `const intentT = await getTranslations("landing.intent")`
    2. Wrap IntentCTA in FadeInSection (from Plan 03-02):
       ```
       <FadeInSection>
         <IntentCTA
           locale={locale as "es" | "en"}
           translations={{
             headline: intentT("headline"),
             subtitle: intentT("subtitle"),
             build: intentT("build"),
             collaborate: intentT("collaborate"),
             connect: intentT("connect"),
             name: intentT("name"),
             email: intentT("email"),
             buildSubmit: intentT("buildSubmit"),
             collaborateSubmit: intentT("collaborateSubmit"),
             connectSubmit: intentT("connectSubmit"),
             buildHelper: intentT("buildHelper"),
             collaborateHelper: intentT("collaborateHelper"),
             connectHelper: intentT("connectHelper"),
             success: intentT("success"),
             questions: intentT("questions"),
             errorName: intentT("errorName"),
             errorEmail: intentT("errorEmail"),
             errorIntent: intentT("errorIntent"),
             errorGeneric: intentT("errorGeneric"),
             submitting: intentT("submitting"),
           }}
         />
       </FadeInSection>
       ```

    Use tabs + double quotes. Follow 03-RESEARCH.md Pattern 5 and Code Examples (Intent Form).
  </action>
  <verify>
    - `bunx biome check src/` passes (all files)
    - `bunx tsc --noEmit` passes
    - `bun run build` succeeds
    - `bun dev` ‚Üí visit localhost:3000/es:
      - IntentCTA section has gradient-purple background with decorative grid (preserved)
      - Click "Quiero construir" card ‚Üí card scales up, border brightens
      - Name and email inputs appear styled on the purple background
      - Submit with empty name ‚Üí inline error message
      - Submit with invalid email ‚Üí inline error message
      - Submit with valid data ‚Üí success message appears, check database for new row
    - Test on /en: all form labels, errors, and success message in English
  </verify>
  <done>
    IntentCTA is a Client Component with 3 selectable intent cards (animated), name/email form fields with Zod validation via Server Action, useActionState for form state management, inline error display, success state, and preserved gradient-purple design. Submissions persist to intent_submissions database table.
  </done>
</task>

</tasks>

<verification>
1. `bunx biome check src/` ‚Äî zero errors
2. `bunx tsc --noEmit` ‚Äî TypeScript clean
3. `bun run build` ‚Äî production build succeeds
4. Manual: Click intent card ‚Üí visual selection feedback (scale + border)
5. Manual: Submit with empty fields ‚Üí validation errors shown inline
6. Manual: Submit with valid data ‚Üí success message shown
7. Database: Query `SELECT * FROM intent_submissions ORDER BY created_at DESC LIMIT 1` ‚Üí new row with correct intent, name, email, locale
8. Manual: Test on both /es and /en ‚Üí all text correctly translated
9. Manual: IntentCTA section still has gradient-purple background and decorative grid overlay
10. Browser console: zero hydration errors
</verification>

<success_criteria>
- 3 intent cards are clickable with Framer Motion selection animation (scale 1.05, border glow)
- Form has name input (min 2 chars), email input (valid email), hidden locale and intent fields
- useActionState manages form state with submitIntent Server Action
- Zod validates on server: invalid data returns field errors, valid data inserts to DB
- Success state replaces form with translated success message
- Inline validation errors display below their respective fields
- Gradient-purple background and decorative grid preserved from Phase 2
- All text driven by translations props (works in both ES and EN)
- Zero hydration errors, zero Biome errors, zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-interactive-components/03-03-SUMMARY.md`
</output>
