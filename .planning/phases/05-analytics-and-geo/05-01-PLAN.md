---
phase: 05-analytics-and-geo
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/analytics/posthog-provider.tsx
  - src/lib/analytics/posthog-pageview.tsx
  - src/lib/analytics/web-vitals.tsx
  - src/app/layout.tsx
autonomous: true
user_setup:
  - service: posthog
    why: "Analytics tracking and event capture"
    env_vars:
      - name: NEXT_PUBLIC_POSTHOG_KEY
        source: "PostHog Dashboard -> Project Settings -> Project API Key"
      - name: NEXT_PUBLIC_POSTHOG_HOST
        source: "PostHog Dashboard -> usually https://us.i.posthog.com or https://eu.i.posthog.com"

must_haves:
  truths:
    - "PostHog SDK initializes in browser without errors when env vars are set"
    - "Pageviews are captured on client-side navigation between /es and /en"
    - "Core Web Vitals metrics (LCP, INP, CLS) are reported to PostHog"
    - "PostHog gracefully skips initialization when env vars are missing (dev mode)"
  artifacts:
    - path: "src/lib/analytics/posthog-provider.tsx"
      provides: "PostHog React provider wrapper"
      contains: "PHProvider"
    - path: "src/lib/analytics/posthog-pageview.tsx"
      provides: "Manual pageview tracking component"
      contains: "PostHogPageView"
    - path: "src/lib/analytics/web-vitals.tsx"
      provides: "Core Web Vitals reporter"
      contains: "WebVitals"
    - path: "src/app/layout.tsx"
      provides: "Root layout with PostHog integration"
      contains: "PHProvider"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/lib/analytics/posthog-provider.tsx"
      via: "PHProvider wrapping body children"
      pattern: "<PHProvider>"
    - from: "src/app/layout.tsx"
      to: "src/lib/analytics/posthog-pageview.tsx"
      via: "PostHogPageView inside Suspense boundary"
      pattern: "<Suspense.*<PostHogPageView"
    - from: "src/lib/analytics/web-vitals.tsx"
      to: "posthog-js/react"
      via: "usePostHog hook to send metrics"
      pattern: "posthog\\.capture"
---

<objective>
Integrate PostHog analytics with manual pageview tracking and Core Web Vitals reporting into the Next.js 16 App Router.

Purpose: Enable visitor behavior tracking (GEO-01) and performance monitoring (GEO-04) so the team can measure landing page effectiveness and Core Web Vitals compliance.
Output: Three analytics modules (provider, pageview, web-vitals) integrated into root layout.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-analytics-and-geo/05-RESEARCH.md
@src/app/layout.tsx
@src/env/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostHog analytics modules</name>
  <files>
    src/lib/analytics/posthog-provider.tsx
    src/lib/analytics/posthog-pageview.tsx
    src/lib/analytics/web-vitals.tsx
  </files>
  <action>
    Install posthog-js:
    ```bash
    bun add posthog-js
    ```

    Create `src/lib/analytics/posthog-provider.tsx`:
    - "use client" directive
    - Import posthog from "posthog-js" and PostHogProvider from "posthog-js/react"
    - Module-level initialization (outside component) guarded by `typeof window !== "undefined"`
    - ALSO guard by checking `process.env.NEXT_PUBLIC_POSTHOG_KEY` exists (graceful skip when env vars missing)
    - Init options: `capture_pageview: false` (manual tracking), `capture_pageleave: true`, `person_profiles: "identified_only"`
    - Use `process.env.NEXT_PUBLIC_POSTHOG_KEY!` and `process.env.NEXT_PUBLIC_POSTHOG_HOST` from env
    - Export `PHProvider` component that wraps children with PostHogProvider client={posthog}
    - When env var is missing, PHProvider should just render children without wrapping in PostHogProvider

    Create `src/lib/analytics/posthog-pageview.tsx`:
    - "use client" directive
    - Import usePathname, useSearchParams from "next/navigation"
    - Import usePostHog from "posthog-js/react"
    - Component `PostHogPageView` that returns null
    - useEffect that captures "$pageview" with $current_url constructed from window.origin + pathname + searchParams
    - Dependencies: [pathname, searchParams, posthog]
    - Guard: only capture if pathname AND posthog are truthy

    Create `src/lib/analytics/web-vitals.tsx`:
    - "use client" directive
    - Import useReportWebVitals from "next/web-vitals"
    - Import usePostHog from "posthog-js/react"
    - Component `WebVitals` that returns null
    - Calls useReportWebVitals with callback that captures "web_vitals" event to PostHog with metric_name, metric_value, metric_id, metric_rating properties
    - Guard: only capture if posthog is truthy (graceful when PostHog not configured)

    Use tabs for indentation, double quotes for strings (Biome conventions).
  </action>
  <verify>
    ```bash
    bun run check
    bunx tsc --noEmit
    ```
    Both pass with zero errors.
  </verify>
  <done>Three analytics modules exist with correct "use client" directives, proper SSR guards, and graceful fallback when PostHog env vars are not set.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate analytics into root layout</name>
  <files>
    src/app/layout.tsx
  </files>
  <action>
    Update `src/app/layout.tsx` to integrate PostHog:

    1. Add imports:
       - `{ Suspense }` from "react"
       - `{ PHProvider }` from "@/lib/analytics/posthog-provider"
       - `{ PostHogPageView }` from "@/lib/analytics/posthog-pageview"
       - `{ WebVitals }` from "@/lib/analytics/web-vitals"

    2. Wrap body children with PHProvider:
       ```tsx
       <body className={...}>
         <PHProvider>
           <Suspense fallback={null}>
             <PostHogPageView />
           </Suspense>
           <WebVitals />
           {children}
         </PHProvider>
       </body>
       ```

    CRITICAL: PostHogPageView MUST be inside a Suspense boundary because it uses useSearchParams (Next.js requirement â€” build will fail without it). WebVitals does NOT need Suspense (no useSearchParams).

    Keep all existing layout code (imports, locale, cn, fonts) unchanged. Only add the analytics wrapping.
  </action>
  <verify>
    ```bash
    bun run check
    bunx tsc --noEmit
    bun run build 2>&1 | tail -20
    ```
    Biome passes, TypeScript compiles, build succeeds without "Missing Suspense boundary" errors.
  </verify>
  <done>Root layout wraps children in PHProvider with Suspense-wrapped PostHogPageView and WebVitals. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `bun run check` passes (Biome lint + format)
2. `bunx tsc --noEmit` passes (TypeScript type checking)
3. `bun run build` succeeds (no Suspense boundary errors, no SSR issues)
4. `bun run dev` starts without errors
5. Files exist: src/lib/analytics/posthog-provider.tsx, posthog-pageview.tsx, web-vitals.tsx
6. Root layout.tsx contains PHProvider wrapping, Suspense-wrapped PostHogPageView, WebVitals
</verification>

<success_criteria>
- PostHog analytics modules created with proper SSR guards and Client Component directives
- Root layout integrates all three analytics components
- Build passes without errors (especially no Suspense boundary warnings)
- PostHog gracefully degrades when env vars are not set (no crashes in dev)
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics-and-geo/05-01-SUMMARY.md`
</output>
